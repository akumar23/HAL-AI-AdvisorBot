{% extends 'admin/master.html' %}
{% block head %}
{{ super() }}
<style>
    .analysis-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .theme-badge {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 20px;
        border-radius: 25px;
        margin: 5px;
        font-weight: 500;
    }
    .recommendation-item {
        padding: 15px;
        border-left: 4px solid #667eea;
        background: #f8f9fa;
        margin-bottom: 10px;
        border-radius: 0 5px 5px 0;
    }
    .recommendation-item:hover {
        background: #f0f0f0;
    }
    .sample-issue {
        padding: 15px;
        border-left: 4px solid #f45c43;
        background: #fff5f5;
        margin-bottom: 10px;
        border-radius: 0 5px 5px 0;
    }
    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    .no-data i {
        font-size: 4rem;
        color: #ddd;
        margin-bottom: 20px;
    }
    .filter-form {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .action-buttons {
        margin-top: 20px;
    }
    .btn-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    .btn-gradient:hover {
        background: linear-gradient(135deg, #5a6fd1 0%, #6a4190 100%);
        color: white;
    }
</style>
{% endblock %}

{% block body %}
<div class="analysis-header">
    <h2>AI-Powered Feedback Analysis</h2>
    <p class="mb-0">Using LLM to identify patterns and generate actionable insights from user feedback</p>
</div>

<!-- Time Filter -->
<div class="filter-form">
    <form method="get" class="form-inline">
        <label class="mr-2">Analyze Period:</label>
        <select name="days" class="form-control mr-2" onchange="this.form.submit()">
            <option value="7" {% if selected_days == 7 %}selected{% endif %}>Last 7 days</option>
            <option value="30" {% if selected_days == 30 %}selected{% endif %}>Last 30 days</option>
            <option value="90" {% if selected_days == 90 %}selected{% endif %}>Last 90 days</option>
        </select>
        <a href="{{ url_for('feedback_analysis.weekly_report') }}" class="btn btn-outline-primary ml-2">
            Get Weekly Report (JSON)
        </a>
    </form>
</div>

{% if insight %}
<!-- Summary -->
<div class="card">
    <h5>Analysis Summary</h5>
    <p class="lead">{{ insight.summary }}</p>
    <small class="text-muted">
        Analyzed {{ insight.analyzed_count }} feedback items |
        Generated on {{ insight.analysis_date }}
    </small>
</div>

<!-- Themes -->
{% if insight.themes %}
<div class="card">
    <h5>Identified Themes</h5>
    <p class="text-muted mb-3">Common patterns found in negative feedback</p>
    {% for theme in insight.themes %}
    <span class="theme-badge">{{ theme }}</span>
    {% endfor %}
</div>
{% endif %}

<!-- Recommendations -->
{% if insight.recommendations %}
<div class="card">
    <h5>Actionable Recommendations</h5>
    <p class="text-muted mb-3">Suggested improvements based on feedback analysis</p>
    {% for rec in insight.recommendations %}
    <div class="recommendation-item">
        <strong>{{ loop.index }}.</strong> {{ rec }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Sample Issues -->
{% if insight.sample_issues %}
<div class="card">
    <h5>Sample Issues</h5>
    <p class="text-muted mb-3">Recent examples of problematic interactions</p>
    {% for issue in insight.sample_issues %}
    <div class="sample-issue">
        <small class="text-muted">{{ issue.date }}</small>
        <p class="mb-1"><strong>User Query:</strong> {{ issue.query }}</p>
        {% if issue.comment %}
        <p class="mb-0"><strong>User Comment:</strong> <em>{{ issue.comment }}</em></p>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Topic-Specific Suggestions -->
<div class="card">
    <h5>Get Topic-Specific Suggestions</h5>
    <p class="text-muted mb-3">Get AI recommendations for improving responses on specific topics</p>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="getSuggestions('prerequisites')">
            Prerequisites
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="getSuggestions('enrollment')">
            Enrollment
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="getSuggestions('advisors')">
            Advisors
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="getSuggestions('deadlines')">
            Deadlines
        </button>
    </div>
    <div id="suggestions-container" class="mt-3" style="display: none;">
        <h6 id="suggestions-topic"></h6>
        <ul id="suggestions-list"></ul>
    </div>
</div>

{% else %}
<!-- No Data State -->
<div class="card no-data">
    <div style="font-size: 4rem; color: #ddd; margin-bottom: 20px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M4.285 9.567a.5.5 0 0 1 .683.183A3.498 3.498 0 0 0 8 11.5a3.498 3.498 0 0 0 3.032-1.75.5.5 0 1 1 .866.5A4.498 4.498 0 0 1 8 12.5a4.498 4.498 0 0 1-3.898-2.25.5.5 0 0 1 .183-.683zM7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5z"/>
        </svg>
    </div>
    <h4>Not Enough Data for Analysis</h4>
    <p class="text-muted">
        There isn't enough feedback in the selected time period to perform meaningful analysis.
        Try selecting a longer time period or wait for more user feedback to accumulate.
    </p>
    <p class="text-muted">
        Minimum required: 5 feedback items
    </p>
</div>
{% endif %}

<script>
function getSuggestions(topic) {
    const container = document.getElementById('suggestions-container');
    const topicEl = document.getElementById('suggestions-topic');
    const listEl = document.getElementById('suggestions-list');

    container.style.display = 'block';
    topicEl.textContent = 'Loading suggestions for ' + topic + '...';
    listEl.innerHTML = '<li>Generating...</li>';

    fetch('{{ url_for("feedback_analysis.get_suggestions", topic="PLACEHOLDER") }}'.replace('PLACEHOLDER', topic))
        .then(response => response.json())
        .then(data => {
            topicEl.textContent = 'Suggestions for improving ' + topic + ' responses:';
            listEl.innerHTML = '';
            if (data.suggestions && data.suggestions.length > 0) {
                data.suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.textContent = suggestion;
                    li.className = 'mb-2';
                    listEl.appendChild(li);
                });
            } else {
                listEl.innerHTML = '<li>No suggestions available</li>';
            }
        })
        .catch(error => {
            topicEl.textContent = 'Error loading suggestions';
            listEl.innerHTML = '<li>Failed to load suggestions. Please try again.</li>';
        });
}
</script>
{% endblock %}
