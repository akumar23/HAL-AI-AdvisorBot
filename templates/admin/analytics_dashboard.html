{% extends 'admin/master.html' %}
{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .stat-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    .stat-card.warning {
        background: linear-gradient(135deg, #F2994A 0%, #F2C94C 100%);
    }
    .stat-card.danger {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    }
    .stat-card.info {
        background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
    }
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
    }
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .topic-bar {
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 10px;
    }
    .topic-bar-fill {
        background: linear-gradient(90deg, #667eea, #764ba2);
        height: 30px;
        display: flex;
        align-items: center;
        padding-left: 10px;
        color: white;
        font-weight: 500;
    }
    .issue-card {
        border-left: 4px solid #eb3349;
        padding: 10px 15px;
        background: #fff5f5;
        margin-bottom: 10px;
        border-radius: 0 5px 5px 0;
    }
    .course-badge {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        margin: 5px;
        font-weight: 500;
    }
    .filter-form {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block body %}
<h2>Analytics Dashboard</h2>

<!-- Time Filter -->
<div class="filter-form">
    <form method="get" class="form-inline">
        <label class="mr-2">Time Period:</label>
        <select name="days" class="form-control mr-2" onchange="this.form.submit()">
            <option value="7" {% if selected_days == 7 %}selected{% endif %}>Last 7 days</option>
            <option value="30" {% if selected_days == 30 %}selected{% endif %}>Last 30 days</option>
            <option value="90" {% if selected_days == 90 %}selected{% endif %}>Last 90 days</option>
            <option value="365" {% if selected_days == 365 %}selected{% endif %}>Last year</option>
        </select>
        <a href="{{ url_for('analytics.export_data', days=selected_days) }}" class="btn btn-outline-primary ml-2">
            Export JSON
        </a>
    </form>
</div>

<!-- Overview Stats -->
<div class="row">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ overview.total_sessions }}</div>
            <div class="stat-label">Total Sessions</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card info">
            <div class="stat-value">{{ overview.user_messages }}</div>
            <div class="stat-label">User Questions</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card success">
            <div class="stat-value">{{ overview.satisfaction_rate }}%</div>
            <div class="stat-label">Satisfaction Rate</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="stat-value">{{ overview.avg_messages_per_session }}</div>
            <div class="stat-label">Avg Messages/Session</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row">
    <div class="col-md-8">
        <div class="chart-container">
            <h5>Daily Usage</h5>
            <canvas id="usageChart" height="100"></canvas>
        </div>
    </div>
    <div class="col-md-4">
        <div class="chart-container">
            <h5>Feedback Distribution</h5>
            <canvas id="feedbackChart" height="150"></canvas>
        </div>
    </div>
</div>

<!-- Topics and Courses -->
<div class="row">
    <div class="col-md-6">
        <div class="chart-container">
            <h5>Popular Topics</h5>
            {% if topics %}
                {% for topic in topics %}
                <div class="topic-bar">
                    <div class="topic-bar-fill" style="width: {{ [topic.percentage * 2, 100] | min }}%;">
                        {{ topic.topic }} ({{ topic.count }})
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No topic data available</p>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h5>Most Queried Courses</h5>
            {% if course_queries %}
                {% for course in course_queries[:10] %}
                <span class="course-badge">
                    {{ course.code }} ({{ course.count }})
                </span>
                {% endfor %}
            {% else %}
                <p class="text-muted">No course query data available</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recent Issues -->
{% if feedback.recent_issues %}
<div class="chart-container">
    <h5>Recent Negative Feedback</h5>
    {% for issue in feedback.recent_issues %}
    <div class="issue-card">
        <small class="text-muted">{{ issue.date }}</small>
        <p class="mb-1"><strong>Query:</strong> {{ issue.query }}</p>
        <p class="mb-0"><strong>Comment:</strong> {{ issue.comment }}</p>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Quick Stats Table -->
<div class="chart-container">
    <h5>Summary Statistics</h5>
    <table class="table table-striped">
        <tr>
            <td>Period</td>
            <td><strong>{{ overview.period_days }} days</strong></td>
        </tr>
        <tr>
            <td>Total Feedback Received</td>
            <td><strong>{{ overview.total_feedback }}</strong></td>
        </tr>
        <tr>
            <td>Positive Feedback</td>
            <td><strong class="text-success">{{ overview.positive_feedback }}</strong></td>
        </tr>
        <tr>
            <td>Negative Feedback</td>
            <td><strong class="text-danger">{{ overview.negative_feedback }}</strong></td>
        </tr>
    </table>
</div>

<script>
// Daily Usage Chart
const usageData = {{ daily_usage | safe }};
const usageCtx = document.getElementById('usageChart').getContext('2d');
new Chart(usageCtx, {
    type: 'line',
    data: {
        labels: usageData.map(d => d.date),
        datasets: [{
            label: 'Sessions',
            data: usageData.map(d => d.sessions),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
            tension: 0.4
        }, {
            label: 'Messages',
            data: usageData.map(d => d.messages),
            borderColor: '#11998e',
            backgroundColor: 'rgba(17, 153, 142, 0.1)',
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Feedback Distribution Chart
const feedbackCtx = document.getElementById('feedbackChart').getContext('2d');
new Chart(feedbackCtx, {
    type: 'doughnut',
    data: {
        labels: ['Positive', 'Negative'],
        datasets: [{
            data: [{{ feedback.positive }}, {{ feedback.negative }}],
            backgroundColor: ['#38ef7d', '#f45c43'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});
</script>
{% endblock %}
